{{- /* Based on https://www.veriphor.com/articles/link-and-image-render-hooks/#image-render-hook */}}

{{- /* Last modified: 2023-12-09T16:29:48-08:00 */}}

{{- /* Initialize. */}}
{{- $renderHookName := "image" }}

{{- /* Verify minimum required version. */}}
{{- $minHugoVersion := "0.114.0" }}
{{- if lt hugo.Version $minHugoVersion }}
{{- errorf "The %q render hook requires Hugo v%s or later." $renderHookName $minHugoVersion }}
{{- end }}

{{- /* Error level when unable to resolve destination: ignore, warning, or error. */}}
{{- $errorLevel := or site.Params.render_hooks.image.errorLevel "ignore" | lower }}

{{- /* Validate error level. */}}
{{- if not (in (slice "ignore" "warning" "error") $errorLevel) }}
{{- errorf "The %q render hook is misconfigured. The errorLevel %q is invalid. Please check your site configuration."
$renderHookName $errorLevel }}
{{- end }}

{{- /* Determine content path for warning and error messages. */}}
{{- $contentPath := "" }}
{{- with .Page.File }}
{{- $contentPath = .Path }}
{{- else }}
{{- $contentPath = .Path }}
{{- end }}

{{- /* Parse destination. */}}
{{- $u := urls.Parse .Destination }}

{{- /* Set common message. */}}
{{- $msg := printf "The %q render hook was unable to resolve the destination %q in %s" $renderHookName $u.String
$contentPath }}

{{- /* Get image resource. */}}
{{- $r := "" }}
{{- if $u.IsAbs }}
{{- with try (resources.GetRemote $u.String) }}
{{- with .Err }}
{{- if eq $errorLevel "warning" }}
{{- warnf "%s. See %s" .Err $contentPath }}
{{- else if eq $errorLevel "error" }}
{{- errorf "%s. See %s" .Err $contentPath }}
{{- end }}
{{- else with .Value }}
{{- /* Destination is a remote resource. */}}
{{- $r = . }}
{{- end }}
{{- else }}
{{- if eq $errorLevel "warning" }}
{{- warnf $msg }}
{{- else if eq $errorLevel "error" }}
{{- errorf $msg }}
{{- end }}
{{- end }}
{{- else }}
{{- with .Page.Resources.Get (strings.TrimPrefix "./" $u.Path) }}
{{- /* Destination is a page resource. */}}
{{- $r = . }}
{{- else }}
{{- with (and (ne .Page.BundleType "leaf") (.Page.CurrentSection.Resources.Get (strings.TrimPrefix "./" $u.Path))) }}
{{- /* Destination is a section resource, and current page is not a leaf bundle. */}}
{{- $r = . }}
{{- else }}
{{- with resources.Get $u.Path }}
{{- /* Destination is a global resource. */}}
{{- $r = . }}
{{- else }}
{{- if eq $errorLevel "warning" }}
{{- warnf $msg }}
{{- else if eq $errorLevel "error" }}
{{- errorf $msg }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}

{{- /* Determine id attribute. */}}
{{- $id := printf "h-rh-i-%d" .Ordinal }}
{{- with .Attributes.id }}
{{- $id = . }}
{{- end }}

{{- /* Logic to handle resolved resource OR fallback */}}
{{- if $r }}
{{/* Convert to webp. */}}
{{- if not (in (slice "gif" "svg") $r.MediaType.SubType) }}
{{- $r = $r.Resize (printf "%dx%d webp" $r.Width $r.Height) }}
{{- end }}

{{- if ne $r.MediaType.SubType "svg" }}
{{- /* Render image element for Resource. */ -}}
<img src="{{ $r.RelPermalink }}" width="{{ string $r.Width }}" height="{{ string $r.Height }}"
    decoding="{{ site.Params.thulite_images.defaults.decoding }}"
    fetchpriority="{{ site.Params.thulite_images.defaults.fetchpriority }}"
    loading="{{ site.Params.thulite_images.defaults.loading }}" alt="{{ .PlainText }}" {{- with .Title
    -}}title="{{ . }}" {{- end }} id="{{ $id }}">
{{- else }}
<img src="{{ $r.RelPermalink }}" decoding="{{ site.Params.thulite_images.defaults.decoding }}"
    fetchpriority="{{ site.Params.thulite_images.defaults.fetchpriority }}"
    loading="{{ site.Params.thulite_images.defaults.loading }}" alt="{{ .PlainText }}" {{- with .Title
    -}}title="{{ . }}" {{- end }} id="{{ $id }}" class="markdown-svg">
{{- end }}

{{- else }}
{{- /* Fallback for missing/static resources (Prevents Build Crash) */ -}}
<img src="{{ .Destination | safeURL }}" alt="{{ .PlainText }}" {{- with .Title -}}title="{{ . }}" {{- end }}
    id="{{ $id }}">
{{- end }}